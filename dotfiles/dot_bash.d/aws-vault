# vim: set filetype=sh :

# Set the AWS vault backend
export AWS_VAULT_BACKEND=file

# Alias aws-vault to av
alias av="aws-vault"

# Use system aws-vault completions for the 'av' alias
if [ -e "${HOMEBREW_PREFIX}/etc/bash_completion.d/aws-vault.bash" ]; then
  source ${HOMEBREW_PREFIX}/etc/bash_completion.d/aws-vault.bash
  complete -F _aws-vault_bash_autocomplete av
fi

ave() {
  if [ -z "$OP_AWS_MFA_NAME" ]; then
    echo "This utility needs the OP_AWS_MFA_NAME environment variable"
    return 1
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    eval $(op signin)
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    echo "Sign-in failed, maybe try again"
    return 1
  fi

  aws-vault exec --mfa-token=$(op get totp "$OP_AWS_MFA_NAME") $@
}
