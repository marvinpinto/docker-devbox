# vim: set filetype=sh :

# Set the AWS vault backend
export AWS_VAULT_BACKEND=file

# Alias aws-vault to av
alias av="aws-vault"

# Use system aws-vault completions for the 'av' alias
if [ -e "${HOMEBREW_PREFIX}/etc/bash_completion.d/aws-vault.bash" ]; then
  source ${HOMEBREW_PREFIX}/etc/bash_completion.d/aws-vault.bash
  complete -F _aws-vault_bash_autocomplete av
fi

function ave-init() {
  local arg=$1

  if [ -z "$OP_AWS_MFA_NAME" ]; then
    echo "This utility needs the OP_AWS_MFA_NAME environment variable"
    return 1
  fi

  if [[ -z "$arg" ]]; then
    echo "usage: ave-init <aws profile name>"
    return 1
  fi

  local avp=$(op get item --vault="Private" "$OP_AWS_MFA_NAME" | jq -r '.details.sections | .[0].fields | .[] | select(.t == "AWS_VAULT_FILE_PASSPHRASE").v')
  if [ "$?" -ne 0 ]; then
    echo "Failed to retrieve AWS_VAULT_FILE_PASSPHRASE"
    return 1
  fi
  export AWS_VAULT_FILE_PASSPHRASE="$avp"
  aws-vault add $arg
}

function ave() {
  if [ -z "$OP_AWS_MFA_NAME" ]; then
    echo "This utility needs the OP_AWS_MFA_NAME environment variable"
    return 1
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    eval $(op signin)
  fi

  OP_ACCT=$(op get account > /dev/null 2>&1)
  if [[ $? != 0 ]]; then
    echo "Sign-in failed, maybe try again"
    return 1
  fi

  aws-vault exec --mfa-token=$(op get totp "$OP_AWS_MFA_NAME") $@
}
